<!DOCTYPE html>
<meta charset="utf-8">
<html>

   <head>
    <title>OCHA Sudan 3W Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/crossfilter.js"></script>
    <script type="text/javascript" src="js/dc.js"></script>
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.1/js/bootstrap.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link rel="stylesheet" type="text/css" href="css/3w-dashboard.css"/>

  </head>
  <body>
    <div class ="col-sm-4 col-md-offset4" id="loading">
        <h1>Loading....  </h1><small>Does not work on IE8 or older</small>
    </div>
    <div class="container" id="dashboard">
      <div class="row">
         <h3>OCHA Sudan - Who does What Where - Presence Dashboard</h3>
      </div>
      <div class="row">
        <div class="col-lg-4">
          <div class="row">
            <div class="col-xs-12"><strong>Latest data:</strong> 1st December 2014  </div>
            <div class="col-xs-12">Explore 3W data for Sudan. Source <a href="http://www.humanitarianresponse.info/operations/sudan" target="_blank" >UN OCHA</a> </div>
            <div id="count-info" class="col-xs-9">
              <small>Hover/click on chart elements or on map to see more data.</small>
            </div>
            <div class="col-xs-3">
              <a class="reset btn btn-primary btn-sm" id="reset" href="javascript:dc.filterAll();dc.redrawAll();">Reset All</a>
            </div>
          </div>            
          <div class="row">
            <div id="status" class="col-xs-6">
              <h4>Org. Type (Who)</h4>
            </div>
            <div id="sector" class="col-xs-6">
              <h4>Sector (What)</h4>
            </div>
          </div>
          <div class="row">
            <div id="orgs" class="col-lg-12">
              <h4>Organisations Name (Who)</h4>
              <div class="col-xs-12">By sector presence count</div>
           </div>
           <div class="col-xs-12"><small style="color:#3182bd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Top 15 organizations</small></div>
          </div>
        </div>
       <div id="map" class="col-lg-8">
          <h3>Map (Where)</h3><p><a href="javascript:stateMapShow();">State</a> - Locality</p>
        </div>
        <div id="map2" class="col-lg-8">
          <h3>Map (Where)</h3><p>State - <a href="javascript:localityMapShow();">Locality</a></p>
        </div>
        <div id = "disclaimer" style = "font-size:80%" class="col-lg-8">
          <small>*Disclaimer: The boundaries and names shown and the designations used on this map do
                  not imply official endorsement or acceptance by the United Nations. Final
                  boundary between the Republic of Sudan and the Republic of South Sudan has
                  not yet been determined. Final status of the Abyei area is not yet determined.
                  Final Locality boundaries for the Kordofan States not verified.<small>
        </div>            
      </div>
      <br>Created by OCHA Sudan - Email: Hassan24@un.org<br> 
    </div>
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-46399763-1']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <script>
        
        function localityMapShow(){
            $('#map2').hide();           
            $('#map').show();
            map2_chart.filterAll();
            dc.redrawAll();
        }
        
        function stateMapShow(){
            $('#map').hide();
            $('#map2').show();
        }
        $('#dashboard').hide();
        $('#map').hide();
        var sector_chart = dc.pieChart("#sector");
        var status_chart = dc.pieChart("#status");
        var map_chart = dc.geoChoroplethChart("#map");
        var org_chart = dc.rowChart("#orgs");
        var map2_chart = dc.geoChoroplethChart("#map2");
        
        d3.csv("data/3W_Data.csv", function(csv_data){
            var cf = crossfilter(csv_data);
            
            cf.sector = cf.dimension(function(d) { return d.Sector; });
            cf.status = cf.dimension(function(d) { return d.Org_Type; });
            cf.pcode = cf.dimension(function(d) { return d.LID; });
            cf.organisation = cf.dimension(function(d) { return d.Organisation; });
            cf.mcode = cf.dimension(function(d) { return d.State; });
            
            var sector = cf.sector.group();
            var status = cf.status.group();
            var pcode = cf.pcode.group();
            var organisation = cf.organisation.group();
            var all = cf.groupAll();
            var mcode = cf.mcode.group();

            sector_chart.width(180).height(180)
                .dimension(cf.sector)
                .group(sector)
                .innerRadius(10) 
                .colors(["#00447F", 
                         "#9ED2FF", 
                         "#81C5FF", 
                         "#003A6D", 
                         "#51AEFF", 
                         "#026cb6", 
                         "#80B6DA", 
                         "#0089FF", 
                         "#1E96FF",
                         "#1971BC"])           
                .colorDomain([0,9])
                .label(function(d){return d.key;})
                .colorAccessor(function(d, i){return i%10;});
            
            status_chart.width(180).height(180)
                .dimension(cf.status)
                .group(status)
                .innerRadius(10)
                .colors(['#CA3351',
                        '#E63133',
                        '#FF5C33',
                        '#FF9147'])
                .colorDomain([0,4])
                .colorAccessor(function(d, i){return i%4;});
            
            org_chart.width(320).height(400)
                .dimension(cf.organisation)
                .group(organisation)
                .elasticX(true)
               .data(function(group) {
                    return group.top(15);
                })
                .colors(['#3182bd'])
                .colorDomain([0,0])
                .colorAccessor(function(d, i){return 1;});
                
            dc.dataCount("#count-info")
        .dimension(cf)
        .group(all);
                            
            d3.json("data/Locality.json", function (localitiesJSON) {

                var locName;
                var stateName;
                var orgNames;

                //Merge the org. data and locality GeoJSON
                for (var j = 0; j < localitiesJSON.features.length; j++) {

                    var jsonLid = localitiesJSON.features[j].properties.LID;
                    var str = [];
                    var s = "";
                    var len = null;

                    for (var i = 0; i < csv_data.length; i++) {

                        var dataLid = csv_data[i].LID;
                              

                        if (jsonLid == dataLid) {

                            str.push(csv_data[i].Organisation);

                        }
                    }

                    // Remove duplicates
                    var uniq = str.reduce(function(a,b){
                        if (a.indexOf(b) < 0 ) a.push(b);
                          return a;
                        },[]);

                          
                    len = uniq.length;

                    for (var r = 0; r < uniq.length; r++){
                        s = s + uniq[r] + ", ";
                    }

                    var sTruncated = s.substring(0,s.length - 2);

                    localitiesJSON.features[j].properties.Org = sTruncated;
                    localitiesJSON.features[j].properties.OrgCount = len;  

                }

                map_chart.width(660).height(600)
                    .dimension(cf.pcode)
                    .group(pcode)
                    .colors(d3.scale.quantize().range(["#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, 85])
                    .overlayGeoJson(localitiesJSON.features, "Locality", function (d) {
                        locName = d.properties.Locality;
                        stateName = d.properties.State;
                        orgNames = d.properties.Org;
                        orgCount = d.properties.OrgCount;

                        return String(d.properties.LID);
                    })
                    .colorCalculator(function (d,i) { return  d? map2_chart.colors()(d) : '#ddd'; })
                    .projection(d3.geo.mercator().center([32.54,15.51]).scale(1700))
                    .title(function (d) {
                        return "State: " + stateName + "\nLocality: " + locName + "\nNumber of organizations: " + orgCount + "\nOrganizations names:\n" + orgNames;
                    });
                    
                    d3.json("data/State.json", function (stateJSON){
                        
                        var state;
                        var orgCount;
                        var stateNames;

                        map2_chart.width(660).height(600)
                            .dimension(cf.mcode)
                            .group(mcode)
                            .colors(d3.scale.quantize().range(["#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                            .colorDomain([0, 22])
                            .overlayGeoJson(stateJSON.features, "States", function (d) {
                                state = d.properties.STATE;
                                orgCount = d.properties.OrgCount;
                                stateNames = d.properties.Org;

                                return d.properties.STATE;
                            })
                            .colorCalculator(function (d,i) { return  d? map2_chart.colors()(d) : '#ddd'; })
                            .projection(d3.geo.mercator().center([32.54,15.51]).scale(1700))
                            .title(function (d) { 

                              var sectorFilter = sector_chart.filter();

                              //Merge the org. data and state GeoJSON
                              for (var j = 0; j < stateJSON.features.length; j++) {

                                var jsonState = stateJSON.features[j].properties.STATE;
                                var str = [];
                                var s = "";
                                var len = null;

                                for (var i = 0; i < csv_data.length; i++) {

                                    var dataState = csv_data[i].State;
                                    var dataSector = csv_data[i].Sector;

                                     if (sectorFilter){

                                      if (jsonState == dataState && String(sectorFilter) == dataSector) {

                                        str.push(csv_data[i].Organisation);

                                      }

                                     }else {

                                      if (jsonState == dataState) {

                                        str.push(csv_data[i].Organisation);

                                      }

                                     }
                                }

                                // Remove duplicates
                                var uniq = str.reduce(function(a,b){
                                if (a.indexOf(b) < 0 ) a.push(b);
                                return a;
                                },[]);

                                
                                len = uniq.length;

                                for (var r = 0; r < uniq.length; r++){
                                  s = s + uniq[r] + ", ";
                                }

                                var sTruncated = s.substring(0,s.length - 2);

                                stateJSON.features[j].properties.Org = sTruncated;
                                stateJSON.features[j].properties.OrgCount = len;  

                              }

                              return "State: " + state + "\nNumber of organizations: " + orgCount + "\nOrganizations names:\n" + stateNames;
                            });
                            $('#loading').hide();
                            $('#dashboard').show();
                            dc.renderAll();
                    });                    
                });            
        });
    </script>

  </body>
</html>
